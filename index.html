<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Service-to-Customer Matrix - Branch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --border: #d0d4dc;
      --accent: #001774;
      --accent-soft: #e3e7fb;
      --text-main: #1f2933;
      --text-soft: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0.75rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
  max-width: 100%;
  padding-left: 2rem;
  padding-right: 2rem;
}

    h1 {
      font-size: 1.4rem;
      margin: 0 0 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-soft);
      margin-bottom: 0.75rem;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 0.9rem 1rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
      border: 1px solid #e4e5f0;
      margin-bottom: 0.75rem;
    }

    .instructions p {
      margin: 0.25rem 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .step-list {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0;
      font-size: 0.9rem;
    }

    .step-list li {
      margin: 0.15rem 0;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: 1px solid var(--accent);
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    button.secondary {
      background: #fff;
      color: var(--accent);
      border-color: var(--accent-soft);
    }

    button.danger {
      border-color: #fecaca;
      background: #fee2e2;
      color: #b91c1c;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .tag {
      font-size: 0.75rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .persona-config {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .persona-config label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-soft);
      display: block;
      margin-bottom: 0.2rem;
      white-space: nowrap; /* keep "PERSONA 2" on one line */
    }

    .persona-config input {
      width: 100%;
      padding: 0.35rem 0.5rem;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      outline: none;
    }

    .persona-config input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .matrix-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e4e5f0;
      background: var(--card);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #f9fafb;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.35rem 0.4rem;
      text-align: left;
      vertical-align: top;
      min-width: 110px;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-soft);
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th.persona-col {
      text-align: center;
      min-width: 90px;
      white-space: nowrap; /* prevent PERSONA X wrapping */
    }

    td.persona-cell {
      text-align: center;
      vertical-align: middle;
    }

    td.persona-cell input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    td input[type="text"],
    td textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid transparent;
      padding: 0.25rem 0.3rem;
      font-size: 0.8rem;
      font-family: inherit;
      resize: vertical;
      background: transparent;
    }

    td textarea {
      min-height: 36px;
      max-height: 120px;
    }

    td input[type="text"]:focus,
    td textarea:focus {
      outline: none;
      border-color: var(--accent-soft);
      background: #f9fafb;
    }

    tr:nth-child(even) td {
      background: #fcfcff;
    }

    tr:hover td {
      background: #f3f4ff;
    }

    td.row-actions {
      min-width: 40px;
      text-align: center;
    }

    .row-remove-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: #9ca3af;
      font-size: 1rem;
      padding: 0.1rem 0.4rem;
    }

    .row-remove-btn:hover {
      color: #b91c1c;
      background: #fee2e2;
    }

    .meta-note {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 0.4rem;
    }

    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      .persona-config {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .toolbar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header style="margin-bottom: 0.75rem;">
      <h1>Service-to-Customer Matrix Tool</h1>
      <p class="subtitle">
        Match your <strong>services</strong> to your <strong>personas</strong> so you can prioritize messaging, offers, and campaigns.
      </p>
    </header>

    <!-- Instructions -->
    <section class="card instructions">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap;">
        <div>
          <p><strong>How to use this tool:</strong></p>
          <ol class="step-list">
            <li><strong>Fill in your primary service groups</strong> (e.g., ‚ÄúNew Construction Services‚Äù).</li>
            <li><strong>Add secondary service groups</strong> under each main group (e.g., ‚ÄúConsulting,‚Äù ‚ÄúField Verification‚Äù).</li>
            <li><strong>Write a brief description</strong> for each service (2‚Äì3 sentences max).</li>
            <li><strong>For each persona</strong>, tick the box if they typically use that service.</li>
            <li><strong><a href="https://static.showit.co/file/wr9rRy9TJXvLyPJbIJQA0Q/280798/screenshot_2025-12-09_at_20_59_24_1.png">CLICK HERE</a></strong> for an example of what a completed matrix looks like.</li>
          </ol>
          <p class="meta-note">
            
          </p>
        </div>
        <div style="min-width:260px;max-width:360px;">
          <span class="tag">Persona Setup</span>
          <p class="meta-note" style="margin-top:0.35rem;">
            Rename personas below to match your ICPs (e.g., ‚ÄúOwner,‚Äù ‚ÄúFacility Manager,‚Äù ‚ÄúMarketing Director‚Äù).
          </p>
          <div class="persona-config" id="persona-config">
            <!-- Persona fields will be inserted here by JS -->
          </div>
        </div>
      </div>
    </section>

    <!-- Toolbar -->
    <section class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <button id="add-row-btn" type="button">
            <span>Ôºã</span>
            <span>Add service row</span>
          </button>
          <button id="download-csv-btn" class="secondary" type="button">
            ‚¨á Export CSV
          </button>
        </div>
        <div class="toolbar-right">
          <button id="clear-all-btn" class="danger" type="button">
            üóë Clear all data
          </button>
        </div>
      </div>

      <!-- Matrix Table -->
      <div class="matrix-wrapper">
        <table id="matrix-table">
          <thead>
            <tr>
              <th style="min-width: 160px;">Main Service Group</th>
              <th style="min-width: 160px;">Secondary Service Group</th>
              <th style="min-width: 260px;">Description</th>
              <!-- Persona headers inserted by JS -->
              <th class="row-actions"></th>
            </tr>
          </thead>
          <tbody id="matrix-body">
            <!-- Rows inserted by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const LOCAL_STORAGE_KEY = 'branch_service_customer_matrix_v2'; // bumped key to avoid old schema issues
    const DEFAULT_PERSONAS = ['Persona 1', 'Persona 2', 'Persona 3', 'Persona 4', 'Persona 5'];

    let personas = [...DEFAULT_PERSONAS];

    const personaConfigEl = document.getElementById('persona-config');
    const matrixTable = document.getElementById('matrix-table');
    const matrixBody = document.getElementById('matrix-body');
    const addRowBtn = document.getElementById('add-row-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn');

    init();

    function init() {
      loadFromStorage();
      renderPersonaInputs();
      renderPersonaHeaders();
      if (matrixBody.children.length === 0) {
        addRow();
      }
      attachGlobalListeners();
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.personas)) {
          personas = parsed.personas;
        }
        if (Array.isArray(parsed.rows)) {
          parsed.rows.forEach(row => addRow(row));
        }
      } catch (err) {
        console.warn('Error loading matrix from storage:', err);
      }
    }

    function saveToStorage() {
      const rows = [];
      const trs = matrixBody.querySelectorAll('tr');
      trs.forEach(tr => {
        const mainGroup = tr.querySelector('input[data-field="mainGroup"]')?.value || '';
        const secondaryGroup = tr.querySelector('input[data-field="secondaryGroup"]')?.value || '';
        const description = tr.querySelector('textarea[data-field="description"]')?.value || '';
        const personaFlags = [];
        tr.querySelectorAll('td.persona-cell input[type="checkbox"]').forEach(cb => {
          personaFlags.push(!!cb.checked);
        });
        rows.push({
          mainGroup,
          secondaryGroup,
          description,
          personas: personaFlags
        });
      });

      const payload = { personas, rows };
      try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(payload));
      } catch (err) {
        console.warn('Error saving matrix to storage:', err);
      }
    }

    function renderPersonaInputs() {
      personaConfigEl.innerHTML = '';
      personas.forEach((name, idx) => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = `Persona ${idx + 1}`;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;
        input.dataset.index = String(idx);
        input.addEventListener('input', onPersonaNameChange);
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        personaConfigEl.appendChild(wrapper);
      });
    }

    function onPersonaNameChange(e) {
      const idx = Number(e.target.dataset.index);
      personas[idx] = e.target.value || DEFAULT_PERSONAS[idx];
      renderPersonaHeaders();
      saveToStorage();
    }

    function renderPersonaHeaders() {
      const theadRow = matrixTable.querySelector('thead tr');
      // base cells: Main, Secondary, Description, Actions = 4
      while (theadRow.children.length > 4) {
        theadRow.removeChild(theadRow.children[theadRow.children.length - 2]);
      }
      personas.forEach((name, i) => {
        const th = document.createElement('th');
        th.className = 'persona-col';
        th.textContent = name || DEFAULT_PERSONAS[i];
        theadRow.insertBefore(th, theadRow.lastElementChild);
      });
      const trs = matrixBody.querySelectorAll('tr');
      trs.forEach(tr => normalizePersonaCells(tr));
    }

    function addRow(data) {
      const tr = document.createElement('tr');

      const tdMain = document.createElement('td');
      const inputMain = document.createElement('input');
      inputMain.type = 'text';
      inputMain.placeholder = 'e.g., New Construction Services';
      inputMain.dataset.field = 'mainGroup';
      if (data && data.mainGroup) inputMain.value = data.mainGroup;
      tdMain.appendChild(inputMain);

      const tdSecondary = document.createElement('td');
      const inputSecondary = document.createElement('input');
      inputSecondary.type = 'text';
      inputSecondary.placeholder = 'e.g., Consulting';
      inputSecondary.dataset.field = 'secondaryGroup';
      if (data && data.secondaryGroup) inputSecondary.value = data.secondaryGroup;
      tdSecondary.appendChild(inputSecondary);

      const tdDescription = document.createElement('td');
      const textareaDesc = document.createElement('textarea');
      textareaDesc.placeholder = '2‚Äì3 sentence high-level description.';
      textareaDesc.dataset.field = 'description';
      if (data && data.description) textareaDesc.value = data.description;
      tdDescription.appendChild(textareaDesc);

      tr.appendChild(tdMain);
      tr.appendChild(tdSecondary);
      tr.appendChild(tdDescription);

      personas.forEach((_, i) => {
        const tdPersona = document.createElement('td');
        tdPersona.className = 'persona-cell';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        if (data && Array.isArray(data.personas) && data.personas[i]) {
          cb.checked = true;
        }
        tdPersona.appendChild(cb);
        tr.appendChild(tdPersona);
      });

      const tdActions = document.createElement('td');
      tdActions.className = 'row-actions';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'row-remove-btn';
      removeBtn.innerHTML = '‚úï';
      removeBtn.title = 'Remove row';
      removeBtn.addEventListener('click', () => {
        tr.remove();
        saveToStorage();
      });
      tdActions.appendChild(removeBtn);
      tr.appendChild(tdActions);

      tr.addEventListener('input', saveToStorage);
      tr.addEventListener('change', saveToStorage);

      matrixBody.appendChild(tr);
      return tr;
    }

    function normalizePersonaCells(tr) {
      const actionCell = tr.lastElementChild;
      // base cells: Main, Secondary, Description, Actions = 4
      while (tr.children.length > 4) {
        tr.removeChild(tr.children[tr.children.length - 2]);
      }
      personas.forEach(() => {
        const td = document.createElement('td');
        td.className = 'persona-cell';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        td.appendChild(cb);
        tr.insertBefore(td, actionCell);
      });
    }

    function attachGlobalListeners() {
      addRowBtn.addEventListener('click', () => {
        addRow();
        saveToStorage();
      });

      clearAllBtn.addEventListener('click', () => {
        const ok = confirm('Clear all matrix data from this browser? This cannot be undone.');
        if (!ok) return;
        matrixBody.innerHTML = '';
        personas = [...DEFAULT_PERSONAS];
        renderPersonaInputs();
        renderPersonaHeaders();
        addRow();
        localStorage.removeItem(LOCAL_STORAGE_KEY);
      });

      downloadCsvBtn.addEventListener('click', downloadAsCsv);
    }

    function downloadAsCsv() {
      const rows = [];
      const header = [
        'Main Service Group',
        'Secondary Service Group',
        'Description',
        ...personas
      ];
      rows.push(header);

      const trs = matrixBody.querySelectorAll('tr');
      trs.forEach(tr => {
        const mainGroup = tr.querySelector('input[data-field="mainGroup"]')?.value || '';
        const secondaryGroup = tr.querySelector('input[data-field="secondaryGroup"]')?.value || '';
        const description = tr.querySelector('textarea[data-field="description"]')?.value || '';
        const personaFlags = [];
        tr.querySelectorAll('td.persona-cell input[type="checkbox"]').forEach(cb => {
          personaFlags.push(cb.checked ? 'X' : '');
        });
        rows.push([mainGroup, secondaryGroup, description, ...personaFlags]);
      });

      const csvContent = rows
        .map(row => row.map(escapeForCsv).join(','))
        .join('\r\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'service-to-customer-matrix.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function escapeForCsv(val) {
      if (val == null) return '';
      const str = String(val);
      if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
  </script>
</body>
</html>
